{% extends "base_logged.html" %}
{% load static %}

{% block extra_css %}{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-8-tablet is-6-desktop">
    <h1 class="title is-4 mb-2">Mis libros deseados</h1>
    <p class="mb-4 has-text-grey">
      Agregá los libros que estás buscando. Podés poner solo el nombre del autor para buscar cualquiera de sus libros.
    </p>

    {# Add Form #}
    <div class="box box-mobile-flat">
      <form method="post" id="book-form">
        {% csrf_token %}

        <div class="field">
          {{ form.author }}
          {% if form.author.errors %}
            <p class="help is-danger">{{ form.author.errors.0 }}</p>
          {% endif %}
        </div>

        <div class="field">
          {{ form.title }}
          {% if form.title.errors %}
            <p class="help is-danger">{{ form.title.errors.0 }}</p>
          {% endif %}
        </div>

        <div class="field is-grouped is-grouped-centered mt-4">
          <div class="control">
            <button type="submit" class="button is-primary">
              Agregar libro
            </button>
          </div>
        </div>
      </form>
    </div>

    {# Books List #}
    {% if wanted_books %}
      <div class="box box-mobile-flat">
        <div class="table-container">
          <table class="table is-fullwidth is-hoverable books-table">
            <tbody>
              {% for book in wanted_books %}
                <tr id="book-row-{{ book.id }}">
                  <td>
                    {% if book.title %}
                      <strong>{{ book.title }}</strong>, {{ book.author }}
                    {% else %}
                      Cualquier libro de <strong>{{ book.author }}</strong>
                    {% endif %}
                  </td>
                  <td class="has-text-right">
                    <button type="button" class="button is-small is-danger is-light js-delete-book-btn" data-delete-url="{% url 'delete_wanted_book' book.id %}" title="Borrar">
                      <span class="icon is-small">
                        <i class="fas fa-trash"></i>
                      </span>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <div class="mt-4 has-text-right">
      <a href="{% url 'profile' username=request.user.username %}" class="button">
        Volver
      </a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Delete buttons
  document.querySelectorAll('.js-delete-book-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const deleteUrl = e.currentTarget.dataset.deleteUrl;
      const row = e.currentTarget.closest('tr');

      try {
        const response = await fetch(deleteUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          row.remove();
        } else {
          alert('Error al borrar el libro.');
        }
      } catch (error) {
        alert('Error al borrar el libro.');
      }
    });
  });
});
</script>
{% endblock %}
