{% extends "base_logged.html" %}
{% load book_filters %}

{% block extra_css %}{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-10-tablet is-8-desktop">
    <div class="mb-3">
      <a href="{% url 'home' %}" class="button is-white">
        <span class="icon is-small">
          <i class="fas fa-arrow-left"></i>
        </span>
        <span>Buscar libros</span>
      </a>
    </div>

    <div class="box box-mobile-flat">
      {# Header with username and info #}
      <div class="is-flex is-justify-content-space-between is-align-items-start mb-3">
        <div class="is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 0.5rem;">
          <h1 class="title is-4 mb-0">
            <span class="icon is-small mr-1">
              <i class="fas fa-user fa-sm"></i>
            </span>
            <span>{{ profile_user.username }}</span>
          </h1>
          <div class="tags">
            {% for location in profile_user.locations.all %}
            <span class="tag location-badge">{{ location.get_area_display }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="buttons">
          {% if is_own_profile %}
          <a href="{% url 'profile_edit' %}" class="button is-small is-link is-light button-fixed-width">
            <span class="icon is-small">
              <i class="fas fa-edit"></i>
            </span>
            <span>Editar</span>
          </a>
          <button id="shareProfileBtn" class="button is-small is-link is-light button-fixed-width">
            <span class="icon is-small">
              <i class="fas fa-arrow-up-right-from-square"></i>
            </span>
            <span id="shareProfileText">Compartir</span>
          </button>
          {% endif %}
        </div>
      </div>

      {% if profile_user.profile.about %}
      <div class="content mb-3">
        <div class="has-text-grey-dark">{{ profile_user.profile.about|linebreaksbr|urlize }}</div>
      </div>
      {% endif %}

      <div class="is-size-7 has-text-grey mb-5">
        <span class="mr-4">
          <span class="icon is-small">
            <i class="fas fa-calendar-alt"></i>
          </span>
          Miembro desde {{ profile_user.date_joined|date:"F Y" }}
        </span>
        <span class="mr-4">
          <span class="icon is-small">
            <i class="fas fa-inbox"></i>
          </span>
          {{ profile_user.received_requests.count }} solicitudes recibidas
        </span>
        <span>
          <span class="icon is-small">
            <i class="fas fa-paper-plane"></i>
          </span>
          {{ profile_user.sent_requests.count }} solicitudes enviadas
        </span>
      </div>

      {% if offered_books or is_own_profile %}
      <hr>

      {# Libros ofrecidos section #}
      <div class="level is-mobile mb-4">
        <div class="level-left">
          <div class="level-item">
            <h2 class="title is-5 mb-0">
              <span class="icon">
                <i class="fas fa-book"></i>
              </span>
              <span>Libros ofrecidos ({{ offered_books|length }})</span>
            </h2>
          </div>
        </div>
        <div class="level-right">
          <div class="level-item">
            {% if is_own_profile %}
            <a href="{% url 'my_offered' %}" class="button is-small is-link is-light button-fixed-width">
              <span class="icon is-small">
                <i class="fas fa-edit"></i>
              </span>
              <span>Editar</span>
            </a>
            {% endif %}
          </div>
        </div>
      </div>

      {% if offered_books %}
      <div class="columns is-multiline mb-3" id="offered-books-container">
        {% for book in offered_books %}
        <div class="column is-12-mobile is-6-tablet offered-book-item" {% if forloop.counter > books_per_page %}style="display: none;"{% endif %}>
          <div class="is-flex" style="gap: 1rem;">
            <div class="is-flex-shrink-0 is-flex is-align-items-center book-cover-container-small{% if is_own_profile %} cover-clickable{% endif %}"{% if is_own_profile %} style="cursor: pointer;"{% endif %} {% if is_own_profile %}data-input-id="photo-input-{{ book.id }}"{% endif %}>
              {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="book-cover-small">
              {% else %}
                <div class="book-placeholder book-cover-container-small is-flex is-justify-content-center is-align-items-center">
                  <span class="icon is-small has-text-grey">
                    <i class="fas fa-book fa-lg"></i>
                  </span>
                </div>
              {% endif %}
            </div>
            <div class="is-flex-grow-1 is-flex is-flex-direction-column is-justify-content-space-between" style="min-height: 90px;">
              <div>
                <div>
                  <strong>{{ book.title }}</strong>, {{ book.author }}
                </div>
                {% if book.notes %}
                  <div class="has-text-grey is-size-7 mt-1">{{ book.notes }}</div>
                {% endif %}
              </div>
              <div class="buttons">
                {% if is_own_profile %}
                  <form method="post" action="{% url 'upload_book_photo' book_id=book.id %}" enctype="multipart/form-data" class="photo-upload-form" style="display: inline;">
                    {% csrf_token %}
                    <input type="file" name="cover_image" accept="image/*" style="display: none;" class="photo-input" id="photo-input-{{ book.id }}">
                    <button type="button" class="button is-info is-small is-light upload-trigger" data-input-id="photo-input-{{ book.id }}">
                      <span class="icon is-small">
                        <i class="fas fa-camera"></i>
                      </span>
                      <span class="upload-text">{% if book.cover_image %}Cambiar foto{% else %}Agregar foto{% endif %}</span>
                    </button>
                  </form>
                  <button type="button" class="button is-small is-success is-light js-trade-book-btn" data-trade-url="{% url 'trade_offered_book' book.id %}" data-book-id="{{ book.id }}">
                    <span>Ya cambiado</span>
                    <span class="icon is-small">
                      <i class="fas fa-check"></i>
                    </span>
                  </button>
                {% else %}
                  {% include '_exchange_button.html' with button_classes='is-small' icon_classes='is-small' %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% if offered_books|length > books_per_page %}
      <div class="has-text-centered mb-5" id="show-more-container">
        <button id="show-more-offered" class="button" data-books-per-page="{{ books_per_page }}">
          <span>Mostrar más</span>
        </button>
      </div>
      {% else %}
      <div class="mb-5"></div>
      {% endif %}
      {% else %}
      <div class="mb-5 nested-content">
        <p class="has-text-grey-light has-text-centered">Sin libros para mostrar</p>
      </div>
      {% endif %}
      {% endif %}

      {% if wanted_books or is_own_profile %}
      <hr>

      {# Libros deseados section #}
      <div class="level is-mobile mb-4">
        <div class="level-left">
          <div class="level-item">
            <h2 class="title is-5 mb-0">
              <span class="icon">
                <i class="fas fa-search"></i>
              </span>
              <span>Libros deseados ({{ wanted_books|length }})</span>
            </h2>
          </div>
        </div>
        <div class="level-right">
          {% if is_own_profile %}
          <div class="level-item">
            <a href="{% url 'my_wanted' %}" class="button is-small is-link is-light button-fixed-width">
              <span class="icon is-small">
                <i class="fas fa-edit"></i>
              </span>
              <span>Editar</span>
            </a>
          </div>
          <div class="level-item">
            <a href="{% url 'home' %}?wanted" class="button is-small is-link is-light button-fixed-width">
              <span class="icon is-small">
                <i class="fas fa-search"></i>
              </span>
              <span>Buscar</span>
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      {% if wanted_books %}
      <ul class="mb-5 nested-content">
        {% for book in wanted_books %}
        <li class="mb-2">
          {% if book.title %}
            <strong>{{ book.title }}</strong>, {{ book.author }}
          {% else %}
            Cualquier libro de <strong>{{ book.author }}</strong>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="mb-5 nested-content">
        <p class="has-text-grey-light has-text-centered">Sin libros para mostrar</p>
      </div>
      {% endif %}
      {% endif %}

      {% if is_own_profile and sent_requests %}
      <hr>

      <h2 class="title is-5 mb-4">
        <span class="icon">
          <i class="fas fa-paper-plane"></i>
        </span>
        <span>Solicitudes enviadas ({{ profile_user.sent_requests.count }})</span>
      </h2>

      <ul class="mb-5 nested-content">
        {% for req in sent_requests %}
        <li class="mb-2">
          <strong>{{ req.book_title }}</strong>, {{ req.book_author }} · {% if req.to_user %}<a href="{% url 'profile' username=req.to_user.username %}" class="is-size-7">{{ req.to_user.username }}</a>{% else %}<span class="is-size-7">usuario desactivado</span>{% endif %} · <span class="has-text-grey is-size-7 timeago-tooltip" data-timestamp="{{ req.created_at|date:'c' }}">{{ req.created_at|timeago }}</span>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if is_own_profile and received_requests %}
      <hr>

      <h2 class="title is-5 mb-4">
        <span class="icon">
          <i class="fas fa-inbox"></i>
        </span>
        <span>Solicitudes recibidas ({{ profile_user.received_requests.count }})</span>
      </h2>

      <ul class="mb-5 nested-content">
        {% for req in received_requests %}
        <li class="mb-2">
          <strong>{{ req.book_title }}</strong>, {{ req.book_author }} · <a href="{% url 'profile' username=req.from_user.username %}" class="is-size-7">{{ req.from_user.username }}</a> · <span class="has-text-grey is-size-7 timeago-tooltip" data-timestamp="{{ req.created_at|date:'c' }}">{{ req.created_at|timeago }}</span>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Show more offered books
  const showMoreBtn = document.getElementById('show-more-offered');
  if (showMoreBtn) {
    const booksPerPage = parseInt(showMoreBtn.dataset.booksPerPage);
    let currentlyShown = booksPerPage;

    showMoreBtn.addEventListener('click', () => {
      const allBooks = document.querySelectorAll('.offered-book-item');
      const hiddenBooks = Array.from(allBooks).filter(book => book.style.display === 'none');

      // Show next batch of books
      const booksToShow = hiddenBooks.slice(0, booksPerPage);
      booksToShow.forEach(book => {
        book.style.display = '';
      });

      currentlyShown += booksToShow.length;

      // Hide container if all books are shown
      if (currentlyShown >= allBooks.length) {
        document.getElementById('show-more-container').style.display = 'none';
      }
    });
  }

  // Timeago tooltips
  document.querySelectorAll('.timeago-tooltip').forEach(element => {
    const timestamp = element.dataset.timestamp;
    if (timestamp) {
      const date = new Date(timestamp);
      element.title = date.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  });

  // Photo upload handling - button clicks
  document.querySelectorAll('.upload-trigger').forEach(button => {
    button.addEventListener('click', () => {
      const inputId = button.dataset.inputId;
      const input = document.getElementById(inputId);
      input.click();
    });
  });

  // Photo upload handling - cover image clicks
  document.querySelectorAll('.cover-clickable').forEach(cover => {
    cover.addEventListener('click', () => {
      const inputId = cover.dataset.inputId;
      const input = document.getElementById(inputId);
      input.click();
    });
  });

  document.querySelectorAll('.photo-input').forEach(input => {
    input.addEventListener('change', async (event) => {
      if (!event.target.files || event.target.files.length === 0) {
        return;
      }

      const form = event.target.closest('.photo-upload-form');
      const button = form.querySelector('.upload-trigger');
      const icon = button.querySelector('i');
      const text = button.querySelector('.upload-text');

      // Show loading state
      const originalIcon = icon.className;
      const originalText = text.textContent;
      icon.className = 'fas fa-spinner fa-pulse';
      text.textContent = 'Subiendo...';
      button.disabled = true;

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          const data = await response.json();

          // Find the cover image container for this book
          const coverContainer = form.closest('.column').querySelector('.cover-clickable');

          // Update the image - either update src or replace placeholder
          if (data.image_url) {
            const existingImg = coverContainer.querySelector('img');
            if (existingImg) {
              // Just update the src attribute
              existingImg.src = data.image_url;
            } else {
              // Replace placeholder div with img
              coverContainer.innerHTML = `<img src="${data.image_url}" alt="Book cover" style="max-width: 60px; max-height: 90px; border-radius: 4px;">`;
            }
          }

          // Update button text to "Cambiar foto"
          text.textContent = 'Cambiar foto';

          // Restore button state
          icon.className = originalIcon;
          button.disabled = false;
        } else {
          // Error - show message and restore button
          const errorText = await response.text();
          alert('Error al subir la foto: ' + (errorText || 'Intentá de nuevo'));
          icon.className = originalIcon;
          text.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        alert('Error al subir la foto. Verificá tu conexión e intentá de nuevo.');
        icon.className = originalIcon;
        text.textContent = originalText;
        button.disabled = false;
      }

      // Reset the file input so the same file can be selected again if needed
      event.target.value = '';
    });
  });

  // Share profile functionality
  const shareBtn = document.getElementById('shareProfileBtn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const profileUrl = window.location.href;
      const username = '{{ profile_user.username }}';
      const text = shareBtn.querySelector('#shareProfileText');
      const icon = shareBtn.querySelector('i');

      try {
        if (navigator.share) {
          // Mobile - use native share sheet
          await navigator.share({
            title: 'GiraLibros - ' + username,
            url: profileUrl
          });
        } else {
          // Desktop - copy to clipboard
          await navigator.clipboard.writeText(profileUrl);

          // Show feedback
          const originalText = text.textContent;
          const originalIcon = icon.className;
          text.textContent = 'Copiado!';
          icon.className = 'fas fa-check';

          setTimeout(() => {
            text.textContent = originalText;
            icon.className = originalIcon;
          }, 2000);
        }
      } catch (err) {
        // Ignore if user cancelled share dialog
        if (err.name !== 'AbortError') {
          console.error('Error sharing:', err);
        }
      }
    });
  }

  // Mark books as traded
  document.querySelectorAll('.js-trade-book-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const tradeUrl = e.currentTarget.dataset.tradeUrl;

      try {
        const response = await fetch(tradeUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error al marcar el libro como cambiado.');
        }
      } catch (error) {
        alert('Error al marcar el libro como cambiado.');
      }
    });
  });
});
</script>
{% endblock %}
