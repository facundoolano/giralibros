{% extends "base_logged.html" %}
{% load book_filters %}

{% block extra_css %}{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-10-tablet is-8-desktop">
    <div class="mb-3">
      <a href="{% url 'home' %}" class="button is-white">
        <span class="icon is-small">
          <i class="fas fa-arrow-left"></i>
        </span>
        <span>Buscar libros</span>
      </a>
    </div>

    <div class="box box-mobile-flat">
      {# Header with username and info #}
      <div class="mb-3">
        <div class="is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 0.5rem;">
          <h1 class="title is-4 mb-0 is-flex is-align-items-center" style="gap: 0.75rem;">
            {% if profile_user.profile.profile_picture %}
            <img src="{{ profile_user.profile.profile_picture.url }}" alt="{{ profile_user.username }}" style="width: 72px; height: 72px; border-radius: 4px; object-fit: cover; object-position: center 25%; flex-shrink: 0;">
            {% else %}
            <span style="width: 72px; height: 72px; border-radius: 4px; flex-shrink: 0; background-color: var(--bulma-scheme-main-bis); display: inline-flex; align-items: center; justify-content: center;">
              <span class="icon is-large has-text-grey"><i class="fas fa-user fa-2x"></i></span>
            </span>
            {% endif %}
            <span>{{ profile_user.username }}</span>
          </h1>
          <div class="tags">
            {% for location in profile_user.locations.all %}
            <span class="tag location-badge">{{ location.get_area_display }}</span>
            {% endfor %}
          </div>
        </div>
      </div>

      {% if profile_user.profile.about %}
      <div class="content mb-3">
        <div class="has-text-grey-dark">{{ profile_user.profile.about|linebreaksbr|urlize }}</div>
      </div>
      {% endif %}

      <div class="field is-grouped is-grouped-multiline mb-5">
        <div class="control is-size-7 has-text-grey">
          <span class="icon is-small mr-1">
            <i class="fas fa-calendar-alt"></i>
          </span>
          <span>Miembro desde {{ profile_user.date_joined|date:"F Y" }}</span>
        </div>
        <div class="control is-size-7 has-text-grey">
          <span class="icon is-small mr-1">
            <i class="fas fa-inbox"></i>
          </span>
          <span>{{ profile_user.received_requests.count }} solicitudes recibidas</span>
        </div>
        <div class="control is-size-7 has-text-grey">
          <span class="icon is-small mr-1">
            <i class="fas fa-paper-plane"></i>
          </span>
          <span>{{ profile_user.sent_requests.count }} solicitudes enviadas</span>
        </div>
      </div>

      {% if is_own_profile %}
      <div class="has-text-centered mb-5">
        <a href="{% url 'profile_edit' %}" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-edit"></i>
          </span>
          <span>Editar perfil</span>
        </a>
        <button id="shareProfileBtn" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-arrow-up-right-from-square"></i>
          </span>
          <span id="shareProfileText">Compartir perfil</span>
        </button>
      </div>
      {% endif %}

      {% if offered_books or is_own_profile %}
      <hr>

      {# Libros ofrecidos section #}
      <h2 class="title is-5">
        <span class="icon">
          <i class="fas fa-book"></i>
        </span>
        <span>Libros ofrecidos ({{ offered_books|length }})</span>
      </h2>

      {% if offered_books %}
      <div class="columns is-multiline mb-3" id="offered-books-container">
        {% for book in offered_books %}
        <div class="column is-12-mobile is-6-tablet offered-book-item" {% if forloop.counter > books_per_page %}style="display: none;"{% endif %}>
          <div class="is-flex" style="gap: 1rem;">
            <div class="is-flex-shrink-0 is-flex is-align-items-center book-cover-container-small">
              {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="book-cover-small">
              {% else %}
                <div class="book-placeholder book-cover-container-small is-flex is-justify-content-center is-align-items-center">
                  <span class="icon is-small has-text-grey">
                    <i class="fas fa-book fa-lg"></i>
                  </span>
                </div>
              {% endif %}
            </div>
            <div class="is-flex-grow-1 is-flex is-flex-direction-column is-justify-content-space-between" style="min-height: 90px;">
              <div>
                <div>
                  <strong>{{ book.title }}</strong>, {{ book.author }}
                </div>
                {% if book.notes_display %}
                  <div class="has-text-grey is-size-7 mt-1">{{ book.notes_display }}</div>
                {% endif %}
              </div>
              <div class="buttons">
                {% if is_own_profile %}
                  <a href="{% url 'edit_offered_book' book.id %}" class="button is-small is-white">
                    <span class="icon is-small">
                      <i class="fas fa-edit"></i>
                    </span>
                    <span>Editar</span>
                  </a>
                {% else %}
                  {% include '_exchange_button.html' with button_classes='is-small' icon_classes='is-small' %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% if offered_books|length > books_per_page %}
      <div class="has-text-centered mb-3" id="show-more-container">
        <button id="show-more-offered" class="button" data-books-per-page="{{ books_per_page }}">
          <span>Mostrar más</span>
        </button>
      </div>
      {% endif %}
      {% if is_own_profile %}
      <div class="has-text-centered mb-5">
        <a href="{% url 'my_offered' %}" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-edit"></i>
          </span>
          <span>Editar libros ofrecidos</span>
        </a>
      </div>
      {% else %}
      <div class="mb-5"></div>
      {% endif %}
      {% else %}
      <div class="mb-5 nested-content">
        <p class="has-text-grey-light has-text-centered">Sin libros para mostrar</p>
      </div>
      {% if is_own_profile %}
      <div class="has-text-centered mb-5">
        <a href="{% url 'my_offered' %}" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-edit"></i>
          </span>
          <span>Editar libros ofrecidos</span>
        </a>
      </div>
      {% endif %}
      {% endif %}
      {% endif %}

      {% if wanted_books or is_own_profile %}
      <hr>

      {# Libros deseados section #}
      <h2 class="title is-5">
        <span class="icon">
          <i class="fas fa-search"></i>
        </span>
        <span>Libros deseados ({{ wanted_books|length }})</span>
      </h2>

      {% if wanted_books %}
      <ul class="mb-3 nested-content">
        {% for book in wanted_books %}
        <li class="mb-2">
          {% if book.title %}
            <strong>{{ book.title }}</strong>, {{ book.author }}
          {% else %}
            Cualquier libro de <strong>{{ book.author }}</strong>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="mb-3 nested-content">
        <p class="has-text-grey-light has-text-centered">Sin libros para mostrar</p>
      </div>
      {% endif %}
      {% if is_own_profile %}
      <div class="has-text-centered mb-5">
        <a href="{% url 'my_wanted' %}" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-edit"></i>
          </span>
          <span>Editar libros deseados</span>
        </a>
        <a href="{% url 'home' %}?wanted" class="button is-white">
          <span class="icon is-small">
            <i class="fas fa-search"></i>
          </span>
          <span>Buscar libros deseados</span>
        </a>
      </div>
      {% else %}
      <div class="mb-5"></div>
      {% endif %}
      {% endif %}

      {% if is_own_profile and traded_books %}
      <hr>

      <h2 class="title is-5">
        <span class="icon">
          <i class="fas fa-rotate"></i>
        </span>
        <span>Libros cambiados ({{ traded_books|length }})</span>
      </h2>

      <ul class="mb-5 nested-content">
        {% for book in traded_books %}
        <li class="mb-2">
          <strong>{{ book.title }}</strong>, {{ book.author }}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if is_own_profile and sent_requests %}
      <hr>

      <h2 class="title is-5">
        <span class="icon">
          <i class="fas fa-paper-plane"></i>
        </span>
        <span>Solicitudes enviadas ({{ profile_user.sent_requests.count }})</span>
      </h2>

      <ul class="mb-5 nested-content">
        {% for req in sent_requests %}
        <li class="mb-2">
          <strong>{{ req.book_title }}</strong>, {{ req.book_author }} · {% if req.to_user %}<a href="{% url 'profile' username=req.to_user.username %}" class="is-size-7">{{ req.to_user.username }}</a>{% else %}<span class="is-size-7">usuario desactivado</span>{% endif %} · <span class="has-text-grey is-size-7 timeago-tooltip" data-timestamp="{{ req.created_at|date:'c' }}">{{ req.created_at|timeago }}</span>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if is_own_profile and received_requests %}
      <hr>

      <h2 class="title is-5">
        <span class="icon">
          <i class="fas fa-inbox"></i>
        </span>
        <span>Solicitudes recibidas ({{ profile_user.received_requests.count }})</span>
      </h2>

      <ul class="mb-5 nested-content">
        {% for req in received_requests %}
        <li class="mb-2">
          <strong>{{ req.book_title }}</strong>, {{ req.book_author }} · <a href="{% url 'profile' username=req.from_user.username %}" class="is-size-7">{{ req.from_user.username }}</a> · <span class="has-text-grey is-size-7 timeago-tooltip" data-timestamp="{{ req.created_at|date:'c' }}">{{ req.created_at|timeago }}</span>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Show more offered books
  const showMoreBtn = document.getElementById('show-more-offered');
  if (showMoreBtn) {
    const booksPerPage = parseInt(showMoreBtn.dataset.booksPerPage);
    let currentlyShown = booksPerPage;

    showMoreBtn.addEventListener('click', () => {
      const allBooks = document.querySelectorAll('.offered-book-item');
      const hiddenBooks = Array.from(allBooks).filter(book => book.style.display === 'none');

      // Show next batch of books
      const booksToShow = hiddenBooks.slice(0, booksPerPage);
      booksToShow.forEach(book => {
        book.style.display = '';
      });

      currentlyShown += booksToShow.length;

      // Hide container if all books are shown
      if (currentlyShown >= allBooks.length) {
        document.getElementById('show-more-container').style.display = 'none';
      }
    });
  }

  // Timeago tooltips
  document.querySelectorAll('.timeago-tooltip').forEach(element => {
    const timestamp = element.dataset.timestamp;
    if (timestamp) {
      const date = new Date(timestamp);
      element.title = date.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  });

  // Share profile functionality
  const shareBtn = document.getElementById('shareProfileBtn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const profileUrl = window.location.href;
      const username = '{{ profile_user.username }}';
      const text = shareBtn.querySelector('#shareProfileText');
      const icon = shareBtn.querySelector('i');

      try {
        if (navigator.share) {
          // Mobile - use native share sheet
          await navigator.share({
            title: 'GiraLibros - ' + username,
            url: profileUrl
          });
        } else {
          // Desktop - copy to clipboard
          await navigator.clipboard.writeText(profileUrl);

          // Show feedback
          const originalText = text.textContent;
          const originalIcon = icon.className;
          text.textContent = 'Copiado!';
          icon.className = 'fas fa-check';

          setTimeout(() => {
            text.textContent = originalText;
            icon.className = originalIcon;
          }, 2000);
        }
      } catch (err) {
        // Ignore if user cancelled share dialog
        if (err.name !== 'AbortError') {
          console.error('Error sharing:', err);
        }
      }
    });
  }
});
</script>
{% endblock %}
