{% extends "base_logged.html" %}
{% load static %}

{% block extra_css %}
<style>
  /* Position delete button in top-right corner */
  .book-entry {
    position: relative;
    padding-right: 3rem; /* Make room for delete button */
  }
  .book-entry .delete {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
  }

  /* Hide deleted entries but keep in DOM for form submission */
  .book-entry.is-deleted {
    display: none;
  }
</style>
{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-10-tablet is-8-desktop">
    <h1 class="title is-4 mb-2">Mis libros ofrecidos</h1>
    <p class="mb-4 has-text-grey">
      Agregá abajo los libros que tenés para cambiar. Usá las observaciones para aclarar lo que quieras (editorial, condición, género, etc).
    </p>

    <form method="post" id="books-form">
      {% csrf_token %}

      <div id="books-container">
        <!-- Example existing books (will be replaced with actual data later) -->
        <div class="box book-entry" data-book-id="1">
          <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro"></button>
          <div class="columns">
            <div class="column">
              <div class="field">
                <input class="input" type="text" name="title_1" value="El túnel" placeholder="Título del libro" required>
              </div>
              <div class="field">
                <input class="input" type="text" name="author_1" value="Ernesto Sábato" placeholder="Autor" required>
              </div>
            </div>
            <div class="column">
              <textarea class="textarea" name="notes_1" rows="4" placeholder="Observaciones (opcional)">Buen estado</textarea>
            </div>
          </div>
        </div>

        <div class="box book-entry" data-book-id="2">
          <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro"></button>
          <div class="columns">
            <div class="column">
              <div class="field">
                <input class="input" type="text" name="title_2" value="Rayuela" placeholder="Título del libro" required>
              </div>
              <div class="field">
                <input class="input" type="text" name="author_2" value="Julio Cortázar" placeholder="Autor" required>
              </div>
            </div>
            <div class="column">
              <textarea class="textarea" name="notes_2" rows="4" placeholder="Observaciones (opcional)"></textarea>
            </div>
          </div>
        </div>

        <!-- Empty entry for new book -->
        <div class="box book-entry new-entry">
          <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro"></button>
          <div class="columns">
            <div class="column">
              <div class="field">
                <input class="input" type="text" name="title_new_1" placeholder="Título del libro" required>
              </div>
              <div class="field">
                <input class="input" type="text" name="author_new_1" placeholder="Autor" required>
              </div>
            </div>
            <div class="column">
              <textarea class="textarea" name="notes_new_1" rows="4" placeholder="Observaciones (opcional)"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="field is-grouped is-grouped-right mt-4">
        <div class="control">
          <button type="button" class="button" id="cancel-btn">
            Cancelar
          </button>
        </div>
        <div class="control">
          <button type="submit" class="button is-primary">
            Guardar cambios
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('books-container');
  const form = document.getElementById('books-form');
  let newEntryCounter = 1;

  // Auto-add new entry when typing in the last entry
  function setupAutoAddEntry() {
    const lastEntry = container.querySelector('.new-entry:last-of-type');
    if (!lastEntry) return;

    const inputs = lastEntry.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
      input.addEventListener('input', (e) => {
        // Check if any field in the last entry has content
        const hasContent = Array.from(inputs).some(inp => inp.value.trim() !== '');

        if (hasContent) {
          // Check if there's already another empty entry
          const emptyEntries = container.querySelectorAll('.new-entry');
          const hasEmptyEntry = Array.from(emptyEntries).some(entry => {
            const entryInputs = entry.querySelectorAll('input[type="text"], textarea');
            return Array.from(entryInputs).every(inp => inp.value.trim() === '');
          });

          if (!hasEmptyEntry) {
            addNewEntry();
          }
        }
      });
    });
  }

  // Add a new empty entry
  function addNewEntry() {
    newEntryCounter++;
    const newEntry = document.createElement('div');
    newEntry.className = 'box book-entry new-entry';
    newEntry.innerHTML = `
      <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro"></button>
      <div class="columns">
        <div class="column">
          <div class="field">
            <input class="input" type="text" name="title_new_${newEntryCounter}" placeholder="Título del libro" required>
          </div>
          <div class="field">
            <input class="input" type="text" name="author_new_${newEntryCounter}" placeholder="Autor" required>
          </div>
        </div>
        <div class="column">
          <textarea class="textarea" name="notes_new_${newEntryCounter}" rows="4" placeholder="Observaciones (opcional)"></textarea>
        </div>
      </div>
    `;
    container.appendChild(newEntry);
    setupAutoAddEntry();
    setupDeleteButtons();
  }

  // Handle delete buttons
  function setupDeleteButtons() {
    const deleteButtons = container.querySelectorAll('.delete-btn');
    deleteButtons.forEach(btn => {
      // Remove old listeners by cloning
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);

      newBtn.addEventListener('click', (e) => {
        const entry = e.currentTarget.closest('.book-entry');

        // If it's an existing book (has data-book-id), mark for deletion
        if (entry.dataset.bookId) {
          entry.classList.add('is-deleted');

          // Add hidden input to mark for deletion (Django formset pattern)
          const deleteInput = document.createElement('input');
          deleteInput.type = 'hidden';
          deleteInput.name = `DELETE_${entry.dataset.bookId}`;
          deleteInput.value = '1';
          entry.appendChild(deleteInput);
        } else {
          // If it's a new entry, just remove it (but keep at least one empty entry)
          const newEntries = container.querySelectorAll('.new-entry:not(.is-deleted)');
          if (newEntries.length > 1) {
            entry.remove();
          } else {
            // Clear the fields instead of removing
            const fields = entry.querySelectorAll('input, textarea');
            fields.forEach(field => field.value = '');
          }
        }
      });
    });
  }

  // Cancel button
  document.getElementById('cancel-btn').addEventListener('click', () => {
    if (confirm('¿Descartar los cambios?')) {
      window.location.reload();
    }
  });

  // Form submission (mock for now)
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    alert('Form submission - backend not implemented yet');
    // TODO: Submit formset
  });

  // Ensure there's always at least one empty entry
  function ensureEmptyEntry() {
    const emptyEntries = container.querySelectorAll('.new-entry');
    const hasEmptyEntry = Array.from(emptyEntries).some(entry => {
      const entryInputs = entry.querySelectorAll('input[type="text"], textarea');
      return Array.from(entryInputs).every(inp => inp.value.trim() === '');
    });

    if (!hasEmptyEntry) {
      addNewEntry();
    }
  }

  // Initialize
  setupAutoAddEntry();
  setupDeleteButtons();
  ensureEmptyEntry();
});
</script>
{% endblock %}
