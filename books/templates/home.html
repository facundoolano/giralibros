{% extends "base_logged.html" %}
{% load static %}
{% load book_filters %}
{% block logged_content %}
<div class="mb-5 has-text-centered" style="margin-top: -1rem">
  {% if search_query %}
  <span class="mr-2">Mostrando resultados para "<strong>{{ search_query }}</strong>" en</span>
  {% for location in user.locations.all %}
  <span class="tag is-light mr-1">{{ location.get_area_display }}</span>
  {% endfor %}
  <div class="mt-2">
    <a href="{% url 'home' %}">Ver todos</a>
  </div>
  {% elif filter_wanted %}
  <span class="mr-2">Mostrando los libros de</span>{% for location in user.locations.all %}<span class="tag is-light mr-1">{{ location.get_area_display }}</span>{% endfor %} que coinciden con tus <a href="{% url 'my_wanted' %}">libros deseados</a>.
  <div class="mt-2">
    <a href="{% url 'home' %}">Ver todos</a>
  </div>
  {% else %}
  <span class="mr-2">Mostrando los Ãºltimos libros disponibles en</span>
  {% for location in user.locations.all %}
  <span class="tag is-light mr-1">{{ location.get_area_display }}</span>
  {% endfor %}
  {% endif %}
</div>

<div class="columns is-centered">
  <div class="column is-full-mobile is-three-quarters-tablet is-half-desktop">
    {% for book in offered_books %}
    <div class="card mb-4">
      <div class="card-content">
        <article class="media">
          <figure class="media-left is-hidden-mobile" style="display: flex; align-items: center; width: 80px; height: 120px; margin-right: 1.5rem;">
            <img src="{% static book.cover_image %}" alt="Book" style="max-width: 80px; max-height: 120px; width: auto; height: auto;">
          </figure>
          <div
            class="media-content"
            style="display: flex; flex-direction: column; min-height: 100px;"
          >
            <div>
              <div class="is-flex is-justify-content-space-between is-align-items-center mb-1">
                <p class="is-size-5"><strong>{{ book.title }}</strong></p>
                <p class="is-size-7 has-text-grey timeago-tooltip" style="white-space: nowrap; margin-left: 1rem;" data-timestamp="{{ book.created_at|date:'c' }}">
                  <span class="icon is-small">
                    <i class="fas fa-clock"></i>
                  </span>
                  <span>{{ book.created_at|timeago }}</span>
                </p>
              </div>
              <p class="mb-2 is-size-6">{{ book.author }}</p>
              {% if book.notes %}
              <p class="is-size-7 has-text-grey mb-2">
                Observaciones: {{ book.notes }}
              </p>
              {% endif %}
            </div>
            <div class="content" style="margin-top: auto">
              <div
                class="is-flex is-justify-content-space-between is-align-items-center"
              >
                <div>
                  <a href="{% url 'profile' username=book.user.username %}" class="mr-2">{{ book.user.username }}</a>
                  {% for location in book.user.locations.all %}
                  <span class="tag is-light mr-1"
                    >{{ location.get_area_display }}</span
                  >
                  {% endfor %}
                </div>
                <div class="is-hidden-mobile">
                  {% include '_exchange_button.html' %}
                </div>
              </div>
            </div>
          </div>
        </article>
      </div>
      <div class="card-content pt-0 is-hidden-tablet">
        <div class="has-text-right">
          {% include '_exchange_button.html' %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="notification is-info is-light">
      <p>No hay libros disponibles en este momento.</p>
    </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.timeago-tooltip').forEach(element => {
    const timestamp = element.dataset.timestamp;
    if (timestamp) {
      const date = new Date(timestamp);
      element.title = date.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  });
});
</script>
{% endblock %}
