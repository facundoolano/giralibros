{% extends "base_logged.html" %}
{% load static %}
{% load book_filters %}
{% block logged_content %}
<div class="mb-5 has-text-centered" style="margin-top: -1rem">
  {% if search_query %}
  <span class="mr-2">Mostrando resultados para "<strong>{{ search_query }}</strong>" en</span>
  {% for location in user.locations.all %}
  <span class="tag location-badge mr-1">{{ location.get_area_display }}</span>
  {% endfor %}
  <div class="mt-2">
    <a href="{% url 'home' %}">Ver todos</a>
  </div>
  {% elif filter_wanted %}
  <span class="mr-2">Mostrando los libros de</span>{% for location in user.locations.all %}<span class="tag location-badge mr-1">{{ location.get_area_display }}</span>{% endfor %} que coinciden con tus <a href="{% url 'my_wanted' %}">libros deseados</a>.
  <div class="mt-2">
    <a href="{% url 'home' %}">Ver todos</a>
  </div>
  {% else %}
  <span class="mr-2">Mostrando los últimos libros disponibles en</span>
  {% for location in user.locations.all %}
  <span class="tag location-badge mr-1">{{ location.get_area_display }}</span>
  {% endfor %}
  {% if user.wanted.exists %}
  <div class="mt-2">
    <a href="{% url 'home' %}?wanted">Mostrar solo mis libros deseados</a>
  </div>
  {% endif %}
  {% endif %}
</div>

{% if not user.offered.exists %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-three-quarters-tablet is-half-desktop">
    <article class="message is-warning">
      <div class="message-body">
        Todavía no agregaste libros a tu perfil.<br>
        Antes de mandar solicitudes de cambio tenés que <a href="{% url 'my_offered' %}">cargar tus libros ofrecidos</a>.
      </div>
    </article>
  </div>
</div>
{% endif %}

<div class="columns is-centered">
  <div class="column is-full-mobile is-three-quarters-tablet is-half-desktop">
    <div id="book-list">
      {% include '_book_list.html' %}
    </div>

    {% if has_next %}
    <div id="infinite-scroll-sentinel" class="has-text-centered py-5">
      <span class="loader"></span>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialize timeago tooltips
  function initTimeagoTooltips() {
    document.querySelectorAll('.timeago-tooltip').forEach(element => {
      const timestamp = element.dataset.timestamp;
      if (timestamp) {
        const date = new Date(timestamp);
        element.title = "Publicado el " + date.toLocaleString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
    });
  }

  // Initialize tooltips for initial page load
  initTimeagoTooltips();

  // Infinite scroll functionality
  const sentinel = document.getElementById('infinite-scroll-sentinel');
  if (!sentinel) return; // No more pages to load

  let currentPage = 1;
  let isLoading = false;

  const loadMoreBooks = async () => {
    if (isLoading) return;
    isLoading = true;

    try {
      const nextPage = currentPage + 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', nextPage);

      const response = await fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const data = await response.json();

      // Insert new books before the sentinel
      const bookList = document.getElementById('book-list');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = data.html;

      // Move all children from temp div to book list
      while (tempDiv.firstChild) {
        bookList.appendChild(tempDiv.firstChild);
      }

      // Initialize tooltips for newly added books
      initTimeagoTooltips();

      currentPage = nextPage;

      // If no more pages, remove the sentinel
      if (!data.has_next) {
        sentinel.remove();
        observer.disconnect();
      }
    } catch (error) {
      console.error('Error loading more books:', error);
      // Optionally show error message to user
    } finally {
      isLoading = false;
    }
  };

  // Set up Intersection Observer
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadMoreBooks();
        }
      });
    },
    {
      rootMargin: '200px' // Start loading 200px before sentinel becomes visible
    }
  );

  observer.observe(sentinel);
});
</script>
{% endblock %}
