{% extends "base_logged.html" %}
{% load static %}
{% load book_filters %}
{% block logged_content %}
<div class="mb-5 has-text-centered" style="margin-top: -1rem">
  {% if not user.is_authenticated %}
  <h1 class="title has-text-centered mb-3">üìö GiraLibros</h1>
  <p class="has-text-centered has-text-grey mb-5">
    La comunidad gratuita de intercambio de libros en Buenos Aires
  </p>
  <div class="buttons is-centered">
    <a href="{% url 'register' %}" class="button is-primary">Registrate</a>
    <a href="{% url 'login' %}" class="button is-light">Inici√° sesi√≥n</a>
  </div>
  <br>
  <p>Estos son algunos de los libros ofrecidos por nuestros usuarios:</p>
  {% else %}
  {# Dynamic filter summary #}
  <span>Mostrando libros</span>
  {% if 'wanted' in request.GET %} <a href="{% url 'my_wanted' %}"><strong>deseados</strong></a>{% endif %}
  {% if 'photo' in request.GET %}
    {% if 'wanted' in request.GET %} y {% endif %}<strong>con foto</strong>
  {% endif %}
  {% if request.GET.search %}
    {% if 'wanted' in request.GET or 'photo' in request.GET %} que coinciden con{% else %} para{% endif %}
    "<strong>{{ request.GET.search }}</strong>"
  {% endif %}
  en
  {% if 'my_locations' in request.GET %}
    {% for location in user.locations.all %}
      <span class="tag location-badge mr-1">{{ location.get_area_display }}</span>
    {% endfor %}
  {% else %}
    todas las ubicaciones
  {% endif %}

  {# Filter editor toggle #}
  <div class="mt-2">
    <a href="#" id="toggle-filters">
      <span class="edit-text"><i class="fas fa-edit"></i> editar filtros</span>
      <span class="hide-text is-hidden"><i class="fas fa-times"></i> ocultar filtros</span>
    </a>
  </div>

  {# Filter form (hidden by default) #}
  <div id="filter-form" class="mt-3 is-hidden">
    <form method="get" action="{% url 'home' %}">
      <div class="is-inline-block has-text-left">
        <div class="field">
          <label class="checkbox">
            <input type="checkbox" name="my_locations" {% if 'my_locations' in request.GET %}checked{% endif %}>
            Solo mis ubicaciones
          </label>
        </div>
        <div class="field">
          <label class="checkbox">
            <input type="checkbox" name="wanted" {% if 'wanted' in request.GET %}checked{% endif %}>
            Solo libros deseados
          </label>
        </div>
        <div class="field">
          <label class="checkbox">
            <input type="checkbox" name="photo" {% if 'photo' in request.GET %}checked{% endif %}>
            Solo libros con foto
          </label>
        </div>
      </div>
      {% if request.GET.search %}
      <input type="hidden" name="search" value="{{ request.GET.search }}">
      {% endif %}
      <div class="field mt-3">
        <button type="submit" class="button is-small is-primary">Aplicar</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>

{% if user.is_authenticated and not user.offered.exists %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-three-quarters-tablet is-half-desktop">
    <article class="message is-warning">
      <div class="message-body">
        Todav√≠a no agregaste libros a tu perfil.<br>
        Antes de mandar solicitudes de cambio ten√©s que <a href="{% url 'my_offered' %}">cargar tus libros ofrecidos</a>.
      </div>
    </article>
  </div>
</div>
{% endif %}

{% if not offered_books %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-three-quarters-tablet is-half-desktop">
    <article class="message is-info">
      <div class="message-body">
        No hay libros disponibles en este momento.
      </div>
    </article>
  </div>
</div>
{% else %}
<div class="columns is-centered">
  <div class="column is-full">
    <div id="book-list">
      {% include '_book_list.html' %}
    </div>

    {% if has_next %}
    <div id="infinite-scroll-sentinel" class="is-flex is-justify-content-center py-6 is-size-2">
      <span class="loader"></span>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialize timeago tooltips
  function initTimeagoTooltips() {
    document.querySelectorAll('.timeago-tooltip').forEach(element => {
      const timestamp = element.dataset.timestamp;
      if (timestamp) {
        const date = new Date(timestamp);
        element.title = "Publicado el " + date.toLocaleString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
    });
  }

  // Initialize tooltips for initial page load
  initTimeagoTooltips();

  // Filter form toggle
  const toggleFiltersLink = document.getElementById('toggle-filters');
  const filterForm = document.getElementById('filter-form');

  if (toggleFiltersLink && filterForm) {
    toggleFiltersLink.addEventListener('click', (e) => {
      e.preventDefault();
      filterForm.classList.toggle('is-hidden');
      toggleFiltersLink.querySelectorAll('.edit-text, .hide-text').forEach(el => {
        el.classList.toggle('is-hidden');
      });
    });
  }

  // Infinite scroll functionality
  const sentinel = document.getElementById('infinite-scroll-sentinel');
  if (!sentinel) return; // No more pages to load

  let currentPage = 1;
  let isLoading = false;

  const loadMoreBooks = async () => {
    if (isLoading) return;
    isLoading = true;

    try {
      const nextPage = currentPage + 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', nextPage);

      const response = await fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const data = await response.json();

      // Insert new books before the sentinel
      const bookList = document.getElementById('book-list');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = data.html;

      // Move all children from temp div to book list
      while (tempDiv.firstChild) {
        bookList.appendChild(tempDiv.firstChild);
      }

      // Initialize tooltips for newly added books
      initTimeagoTooltips();

      currentPage = nextPage;

      // If no more pages, remove the sentinel
      if (!data.has_next) {
        sentinel.remove();
        observer.disconnect();
      }
    } catch (error) {
      console.error('Error loading more books:', error);
      // Optionally show error message to user
    } finally {
      isLoading = false;
    }
  };

  // Set up Intersection Observer
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadMoreBooks();
        }
      });
    },
    {
      rootMargin: '200px' // Start loading 200px before sentinel becomes visible
    }
  );

  observer.observe(sentinel);
});
</script>
{% endblock %}
