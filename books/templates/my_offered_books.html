{% extends "base_logged.html" %}
{% load static %}

{% block extra_css %}{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-8-tablet is-6-desktop">
    <h1 class="title is-4 mb-2">Mis libros ofrecidos</h1>
    <p class="mb-4 has-text-grey">
      Agregá abajo los libros que tenés para cambiar. Usá las observaciones para aclarar lo que quieras (editorial, condición, género, etc).
    </p>

    <form method="post" id="books-form">
      {% csrf_token %}
      {{ formset.management_form }}

      <div id="books-container">
        {% for form in formset %}
          <div class="box book-entry {{ forloop.last|yesno:'new-entry,' }}" {% if form.instance.pk %}data-book-id="{{ form.instance.pk }}"{% endif %}>
            <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro" tabindex="-1"></button>

            {# Hidden fields for formset #}
            {{ form.id }}
            {{ form.temp_cover_id }}

            <div class="columns">
              {# Left column on desktop: Form fields #}
              <div class="column">
                <div class="field">
                  <input class="input" type="text" name="{{ form.title.html_name }}" id="{{ form.title.id_for_label }}" value="{{ form.title.value|default:'' }}" placeholder="Título del libro">
                  {% if form.title.errors %}
                    <p class="help is-danger">{{ form.title.errors.0 }}</p>
                  {% endif %}
                </div>
                <div class="field">
                  <input class="input" type="text" name="{{ form.author.html_name }}" id="{{ form.author.id_for_label }}" value="{{ form.author.value|default:'' }}" placeholder="Autor">
                  {% if form.author.errors %}
                    <p class="help is-danger">{{ form.author.errors.0 }}</p>
                  {% endif %}
                </div>
                <div class="field">
                  {{ form.notes }}
                  {% if form.notes.errors %}
                    <p class="help is-danger">{{ form.notes.errors.0 }}</p>
                  {% endif %}
                </div>
              </div>

              {# Right column on desktop: Image and upload button #}
              <div class="column is-narrow">
                <div class="is-flex is-flex-direction-column" style="gap: 0.5rem;">
                  <div class="temp-photo-container is-flex is-align-items-center book-cover-container" data-form-prefix="{{ form.prefix }}">
                    {% if form.instance.cover_image %}
                      <img src="{{ form.instance.cover_image.url }}" alt="Cover" class="book-cover-image">
                    {% else %}
                      <div class="book-placeholder book-cover-container is-flex is-justify-content-center is-align-items-center">
                        <span class="icon is-medium has-text-grey-dark">
                          <i class="fas fa-book fa-lg"></i>
                        </span>
                      </div>
                    {% endif %}
                  </div>
                  <div>
                    <input type="file" name="temp_cover_image" accept="image/*" capture="environment" style="display: none;" class="temp-photo-input" data-form-prefix="{{ form.prefix }}">
                    <button type="button" class="button is-info is-small is-light temp-upload-trigger" data-form-prefix="{{ form.prefix }}">
                      <span class="icon is-small">
                        <i class="fas fa-camera"></i>
                      </span>
                      <span class="temp-upload-text">{% if form.instance.cover_image %}Cambiar foto{% else %}Agregar foto{% endif %}</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {# Hidden DELETE checkbox (we'll handle this with JavaScript) #}
            <div style="display: none;">
              {{ form.DELETE }}
            </div>
          </div>
        {% endfor %}
      </div>

      {# Template for new entries - using Django's empty_form #}
      <template id="empty-form-template">
        <div class="box book-entry new-entry">
          <button type="button" class="delete delete-btn" aria-label="Eliminar" title="Borrar libro" tabindex="-1"></button>

          {# Hidden fields for formset #}
          {{ formset.empty_form.id }}
          {{ formset.empty_form.temp_cover_id }}

          <div class="columns">
            {# Left column on desktop: Form fields #}
            <div class="column">
              <div class="field">
                <input class="input" type="text" name="{{ formset.empty_form.title.html_name }}" id="{{ formset.empty_form.title.id_for_label }}" value="" placeholder="Título del libro">
              </div>
              <div class="field">
                <input class="input" type="text" name="{{ formset.empty_form.author.html_name }}" id="{{ formset.empty_form.author.id_for_label }}" value="" placeholder="Autor">
              </div>
              <div class="field">
                {{ formset.empty_form.notes }}
              </div>
            </div>

            {# Right column on desktop: Image and upload button #}
            <div class="column is-narrow">
              <div class="is-flex is-flex-direction-column" style="gap: 0.5rem;">
                <div class="temp-photo-container is-flex is-align-items-center book-cover-container" data-form-prefix="{{ formset.empty_form.prefix }}">
                  <div class="book-placeholder book-cover-container is-flex is-justify-content-center is-align-items-center">
                    <span class="icon is-medium has-text-grey-dark">
                      <i class="fas fa-book fa-lg"></i>
                    </span>
                  </div>
                </div>
                <div>
                  <input type="file" name="temp_cover_image" accept="image/*" capture="environment" style="display: none;" class="temp-photo-input" data-form-prefix="{{ formset.empty_form.prefix }}">
                  <button type="button" class="button is-info is-small is-light temp-upload-trigger" data-form-prefix="{{ formset.empty_form.prefix }}">
                    <span class="icon is-small">
                      <i class="fas fa-camera"></i>
                    </span>
                    <span class="temp-upload-text">Agregar foto</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          {# Hidden DELETE checkbox #}
          <div style="display: none;">
            {{ formset.empty_form.DELETE }}
          </div>
        </div>
      </template>

      <div class="field is-grouped is-grouped-right mt-4">
        <div class="control">
          <button type="button" class="button" id="cancel-btn">
            <span id="cancel-btn-text">Volver</span>
          </button>
        </div>
        <div class="control" id="save-btn-container" style="display: none;">
          <button type="submit" class="button is-primary">
            Guardar cambios
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script src="{% static 'js/book_formset_manager.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  initBookFormset({
    profileUrl: "{% url 'profile' username=request.user.username %}",
    tempUploadUrl: "{% url 'upload_temp_book_photo' %}"
  });
});
</script>
{% endblock %}
