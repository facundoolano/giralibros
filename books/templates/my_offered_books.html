{% extends "base_logged.html" %}
{% load static %}

{% block extra_css %}{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-8-tablet is-6-desktop">
    <h1 class="title is-4 mb-2">Mis libros ofrecidos</h1>
    <p class="mb-4 has-text-grey">
      Agregá los libros que tenés para cambiar. Usá las observaciones para aclarar lo que quieras (editorial, condición, género, etc).
    </p>

    {# Add/Edit Form #}
    <div class="box">
      <form method="post" enctype="multipart/form-data" id="book-form">
        {% csrf_token %}

        <div class="columns">
          {# Left column: Form fields #}
          <div class="column">
            <div class="field">
              {{ form.title }}
              {% if form.title.errors %}
                <p class="help is-danger">{{ form.title.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="field">
              {{ form.author }}
              {% if form.author.errors %}
                <p class="help is-danger">{{ form.author.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="field">
              {{ form.notes }}
              {% if form.notes.errors %}
                <p class="help is-danger">{{ form.notes.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          {# Right column: Photo upload #}
          <div class="column is-narrow">
            <div class="is-flex is-flex-direction-column" style="gap: 0.5rem;">
              <div id="photo-preview-container" class="is-flex is-align-items-center book-cover-container">
                {% if form.instance.cover_image %}
                  <img src="{{ form.instance.cover_image.url }}" alt="Cover" class="book-cover-image" id="photo-preview">
                {% else %}
                  <div class="book-placeholder book-cover-container is-flex is-justify-content-center is-align-items-center">
                    <span class="icon is-medium has-text-grey-dark">
                      <i class="fas fa-book fa-lg"></i>
                    </span>
                  </div>
                {% endif %}
              </div>
              <div>
                <input type="file" name="cover_image" id="js-cover-image-input" accept="image/*" style="display: none;">
                <button type="button" class="button is-info is-small is-light" id="js-photo-upload-btn">
                  <span class="icon is-small">
                    <i class="fas fa-camera"></i>
                  </span>
                  <span id="photo-upload-text">{% if form.instance.cover_image %}Cambiar foto{% else %}Agregar foto{% endif %}</span>
                </button>
                {% if form.cover_image.errors %}
                  <p class="help is-danger">{{ form.cover_image.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="field is-grouped is-grouped-right mt-4">
          <div class="control">
            <button type="submit" class="button is-primary">
              {% if editing_book_id %}Guardar cambios{% else %}Agregar libro{% endif %}
            </button>
          </div>
        </div>
      </form>
    </div>

    {# Books List #}
    {% if offered_books %}
      <div class="box">
        <h2 class="subtitle is-5 mb-3">Tus libros</h2>

        <div class="table-container">
          <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
              <tr>
                <th>Título</th>
                <th>Autor</th>
                <th class="has-text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for book in offered_books %}
                <tr id="book-row-{{ book.id }}">
                  <td>{{ book.title }}</td>
                  <td>{{ book.author }}</td>
                  <td class="has-text-right">
                    <div class="buttons is-right">
                      <button type="button" class="button is-small is-danger is-light js-delete-book-btn" data-delete-url="{% url 'delete_offered_book' book.id %}" title="Borrar">
                        <span class="icon is-small">
                          <i class="fas fa-trash"></i>
                        </span>
                      </button>
                      <a href="{% url 'edit_offered_book' book.id %}" class="button is-small is-info is-light" title="Editar">
                        <span class="icon is-small">
                          <i class="fas fa-edit"></i>
                        </span>
                      </a>
                      <button type="button" class="button is-small is-success is-light js-mark-exchanged-btn" data-delete-url="{% url 'delete_offered_book' book.id %}">
                        <span>Ya cambiado</span>
                        <span class="icon is-small">
                          <i class="fas fa-check"></i>
                        </span>
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <div class="mt-4 has-text-right">
      <a href="{% url 'profile' username=request.user.username %}" class="button">
        Volver
      </a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Photo upload: trigger file input
  document.getElementById('js-photo-upload-btn').addEventListener('click', () => {
    document.getElementById('js-cover-image-input').click();
  });

  // Photo upload: show preview
  document.getElementById('js-cover-image-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      document.getElementById('photo-preview-container').innerHTML =
        `<img src="${event.target.result}" alt="Preview" class="book-cover-image">`;
      document.getElementById('photo-upload-text').textContent = 'Cambiar foto';
    };
    reader.readAsDataURL(file);
  });

  // Delete buttons
  document.querySelectorAll('.js-delete-book-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const deleteUrl = e.currentTarget.dataset.deleteUrl;
      const row = e.currentTarget.closest('tr');

      try {
        const response = await fetch(deleteUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          row.remove();
        } else {
          alert('Error al borrar el libro.');
        }
      } catch (error) {
        alert('Error al borrar el libro.');
      }
    });
  });

  // Mark as exchanged buttons (for now, same as delete)
  document.querySelectorAll('.js-mark-exchanged-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const deleteUrl = e.currentTarget.dataset.deleteUrl;
      const row = e.currentTarget.closest('tr');

      try {
        const response = await fetch(deleteUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          row.remove();
        } else {
          alert('Error al marcar el libro.');
        }
      } catch (error) {
        alert('Error al marcar el libro.');
      }
    });
  });
});
</script>
{% endblock %}
