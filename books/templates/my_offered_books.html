{% extends "base_logged.html" %}
{% load static %}

{% block extra_css %}
<style>
  @media screen and (min-width: 769px) {
    .books-table {
      table-layout: fixed;
    }
    .books-table td:first-child {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .books-table td:last-child {
      width: 100px;
      white-space: nowrap;
    }
  }

  @media screen and (max-width: 768px) {
    .books-table, .books-table tbody, .books-table tr {
      display: block;
    }
    .books-table td {
      display: block;
      width: 100%;
      border: none;
      padding-left: 0;
      padding-right: 0;
    }
    .books-table td:first-child {
      padding-bottom: 0.5rem;
    }
    .books-table td:last-child {
      padding-top: 0;
    }
    .books-table tr {
      border-bottom: 1px solid #dbdbdb;
    }
    .books-table tr:last-child {
      border-bottom: none;
    }

    #book-form .columns .column.is-narrow {
      display: block;
      float: left;
      width: 120px;
      margin-right: 1rem;
      margin-bottom: 1rem;
    }

    #book-operations .buttons {
      flex-direction: column;
    }

    #book-operations .buttons .button {
      width: 100%;
      margin-bottom: 0.5rem;
      margin-right: 0;
    }
  }

  .books-table tbody tr {
    cursor: pointer;
  }
</style>
{% endblock %}

{% block logged_content %}
<div class="columns is-centered">
  <div class="column is-full-mobile is-8-tablet is-6-desktop">
    <h1 class="title is-4 mb-2">Mis libros ofrecidos</h1>
    <p class="mb-4 has-text-grey">
      Agregá los libros que tenés para cambiar. Usá las observaciones para aclarar lo que quieras (editorial, condición, género, etc).
    </p>

    {# Add/Edit Form #}
    <div class="box box-mobile-flat">
      <form method="post" enctype="multipart/form-data" id="book-form">
        {% csrf_token %}

        <div class="columns">
          {# Left column: Form fields #}
          <div class="column">
            <div class="field">
              {{ form.title }}
              {% if form.title.errors %}
                <p class="help is-danger">{{ form.title.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="field">
              {{ form.author }}
              {% if form.author.errors %}
                <p class="help is-danger">{{ form.author.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="field">
              {{ form.notes }}
              {% if form.notes.errors %}
                <p class="help is-danger">{{ form.notes.errors.0 }}</p>
              {% endif %}
            </div>

            {% if editing_book_id %}
            <div class="field" id="book-operations">
              <div class="buttons">
                <button type="button" class="button is-small is-info is-light" id="js-photo-upload-btn-ops">
                  <span class="icon is-small">
                    <i class="fas fa-camera"></i>
                  </span>
                  <span>{% if form.instance.cover_image %}Cambiar foto{% else %}Agregar foto{% endif %}</span>
                </button>
                <button type="button" class="button is-small is-danger is-light js-delete-book-btn" data-delete-url="{% url 'delete_offered_book' editing_book_id %}">
                  <span class="icon is-small">
                    <i class="fas fa-trash"></i>
                  </span>
                  <span>Borrar</span>
                </button>
                {% if form.instance.is_reserved %}
                <button type="button" class="button is-small is-light js-reserve-book-btn" data-reserve-url="{% url 'reserve_offered_book' editing_book_id %}">
                  <span class="icon is-small">
                    <i class="fa fa-play"></i>
                  </span>
                  <span>Desreservar</span>
                </button>
                {% else %}
                <button type="button" class="button is-small is-light js-reserve-book-btn" data-reserve-url="{% url 'reserve_offered_book' editing_book_id %}">
                  <span class="icon is-small">
                    <i class="fa fa-pause"></i>
                  </span>
                  <span>Reservar</span>
                </button>
                {% endif %}
                <button type="button" class="button is-small is-success is-light js-mark-exchanged-btn" data-trade-url="{% url 'trade_offered_book' editing_book_id %}">
                  <span class="icon is-small">
                    <i class="fas fa-check"></i>
                  </span>
                  <span>Cambiado</span>
                </button>
              </div>
            </div>
            {% endif %}
          </div>

          {# Right column: Photo preview #}
          <div class="column is-narrow">
            <input type="file" name="cover_image" id="js-cover-image-input" accept="image/*" style="display: none;">
            {% if form.cover_image.errors %}
              <p class="help is-danger">{{ form.cover_image.errors.0 }}</p>
            {% endif %}
            <div id="photo-preview-container" class="is-flex is-align-items-center book-cover-container">
              {% if form.instance.cover_image %}
                <img src="{{ form.instance.cover_image.url }}" alt="Cover" class="book-cover-image" id="photo-preview">
              {% else %}
                <div class="book-placeholder book-cover-container is-flex is-justify-content-center is-align-items-center">
                  <span class="icon is-medium has-text-grey">
                    <i class="fas fa-book fa-2x"></i>
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="field is-grouped is-grouped-centered mt-4">
          <div class="control">
            <button type="submit" class="button is-primary">
              {% if editing_book_id %}Guardar cambios{% else %}Agregar libro{% endif %}
            </button>
          </div>
        </div>
      </form>
    </div>

    {# Books List #}
    {% if offered_books %}
      <div class="box box-mobile-flat">
        <div class="table-container">
          <table class="table is-fullwidth books-table">
            <tbody>
              {% for book in offered_books %}
                <tr id="book-row-{{ book.id }}" data-edit-url="{% url 'edit_offered_book' book.id %}">
                  <td><strong>{{ book.title }}</strong>, {{ book.author }}</td>
                  <td class="has-text-right">
                    <a href="{% url 'edit_offered_book' book.id %}" class="button is-small is-white">
                      <span class="icon is-small">
                        <i class="fas fa-edit"></i>
                      </span>
                      <span>Editar</span>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <div class="mt-4 has-text-right">
      <a href="{% url 'profile' username=request.user.username %}" class="button">
        Volver
      </a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Make table rows clickable to edit
  document.querySelectorAll('.books-table tbody tr').forEach(row => {
    row.addEventListener('click', (e) => {
      // Don't navigate if clicking on buttons
      if (e.target.closest('button') || e.target.closest('a')) {
        return;
      }
      const editUrl = row.dataset.editUrl;
      if (editUrl) {
        window.location.href = editUrl;
      }
    });
  });

  // Photo upload: trigger file input from operations button (if it exists)
  const photoUploadBtnOps = document.getElementById('js-photo-upload-btn-ops');
  if (photoUploadBtnOps) {
    photoUploadBtnOps.addEventListener('click', () => {
      document.getElementById('js-cover-image-input').click();
    });
  }

  // Photo upload: show preview
  document.getElementById('js-cover-image-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      document.getElementById('photo-preview-container').innerHTML =
        `<img src="${event.target.result}" alt="Preview" class="book-cover-image">`;

      // Update button text in operations if it exists
      const photoUploadBtnOps = document.getElementById('js-photo-upload-btn-ops');
      if (photoUploadBtnOps) {
        const textSpan = photoUploadBtnOps.querySelector('span:not(.icon)');
        if (textSpan) {
          textSpan.textContent = 'Cambiar foto';
        }
      }
    };
    reader.readAsDataURL(file);
  });

  // Delete buttons
  document.querySelectorAll('.js-delete-book-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const deleteUrl = e.currentTarget.dataset.deleteUrl;
      const row = e.currentTarget.closest('tr');

      try {
        const response = await fetch(deleteUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          row.remove();
        } else {
          alert('Error al borrar el libro.');
        }
      } catch (error) {
        alert('Error al borrar el libro.');
      }
    });
  });

  // Mark as exchanged buttons
  document.querySelectorAll('.js-mark-exchanged-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const tradeUrl = e.currentTarget.dataset.tradeUrl;
      const row = e.currentTarget.closest('tr');

      try {
        const response = await fetch(tradeUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          row.remove();
        } else {
          alert('Error al marcar el libro.');
        }
      } catch (error) {
        alert('Error al marcar el libro.');
      }
    });
  });

  // Reserve/unreserve books
  document.querySelectorAll('.js-reserve-book-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const reserveUrl = e.currentTarget.dataset.reserveUrl;

      try {
        const response = await fetch(reserveUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error al cambiar el estado de reserva.');
        }
      } catch (error) {
        alert('Error al cambiar el estado de reserva.');
      }
    });
  });
});
</script>
{% endblock %}
